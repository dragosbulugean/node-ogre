<!DOCTYPE html>

<html>
<head>
  <title>PersistenceManager.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>PersistenceManager.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/**
 * Created by Dragos on 8/19/14.
 */</span>

<span class="hljs-keyword">var</span> Promise = <span class="hljs-built_in">require</span>(<span class="hljs-string">'bluebird'</span>)
<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>)
<span class="hljs-keyword">var</span> Constants = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Constants'</span>)
<span class="hljs-keyword">var</span> FieldTypes = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./FieldTypes'</span>)
<span class="hljs-keyword">var</span> StringGenerator = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./StringGenerator'</span>)
<span class="hljs-keyword">var</span> sg = <span class="hljs-keyword">new</span> StringGenerator()
<span class="hljs-keyword">var</span> Model = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Model'</span>)

<span class="hljs-keyword">var</span> persistModel = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model)</span> </span>{
	<span class="hljs-keyword">var</span> deferred = Promise.defer()
	<span class="hljs-keyword">var</span> data = {}

	<span class="hljs-keyword">var</span> validationMessages = model.validate()
	<span class="hljs-keyword">if</span>(!_.isEmpty(validationMessages)) {
		setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
			<span class="hljs-keyword">return</span> deferred.reject(validationMessages)
		}, <span class="hljs-number">1</span>)
		<span class="hljs-keyword">return</span> deferred.promise
	}

	_.each(model.getPrimitiveFields(), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(field)</span></span>{
			<span class="hljs-keyword">if</span>(model.definition[field].type == FieldTypes.Date) {
				<span class="hljs-keyword">if</span>(!_.isUndefined(model[field])) {
					<span class="hljs-keyword">if</span> (model[field] <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Date</span>) {
						data[field] = model[field].getTime()
					} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (model[field]._isAMomentObject) {
						data[field] = model[field].toDate().getTime()
					}
				}
			}
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(model.definition[field].type == FieldTypes.Array) {
				data[field] = model[field]
			}
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(model.definition[field].type == FieldTypes.JSON) {
				data[field] = <span class="hljs-built_in">JSON</span>.stringify(model[field])
			}
			<span class="hljs-keyword">else</span> {
				data[field] = model[field]
			}
	}, model)

	<span class="hljs-keyword">var</span> persistQuery = <span class="hljs-string">''</span>
	<span class="hljs-keyword">if</span>(_.isUndefined(model.id)) {
		<span class="hljs-keyword">delete</span> data.id
		persistQuery += sg.getCreate(model.label, <span class="hljs-string">'n'</span>, <span class="hljs-string">'node'</span>) + <span class="hljs-string">'RETURN n'</span>
	} <span class="hljs-keyword">else</span> {
		persistQuery += sg.getMatch(model.label, <span class="hljs-string">'n'</span>) + sg.getWhereId(<span class="hljs-string">'n'</span>, <span class="hljs-string">'{nodeID}'</span>) + <span class="hljs-string">'SET n={node} RETURN n'</span>
	}

	model.db().queryOneNodeAsync(persistQuery, {nodeID: model.id,node:data}).bind(model)
		.then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(node)</span></span>{
			<span class="hljs-keyword">if</span>(model.getEvents()[Constants.Events.postCreate])
				model.getEvents()[Constants.Events.postCreate].run(model)
			model.set(<span class="hljs-string">'id'</span>, node.id)
			model.isSyncronised = <span class="hljs-literal">true</span>
			<span class="hljs-keyword">return</span> deferred.resolve(model)
		})
		.catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span></span>{
			<span class="hljs-keyword">return</span> deferred.reject(err)
		})

	<span class="hljs-keyword">return</span> deferred.promise
}

<span class="hljs-keyword">var</span> persistOneRelation = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model, field)</span> </span>{
	<span class="hljs-keyword">var</span> deferred = Promise.defer()

	<span class="hljs-keyword">var</span> createRelation = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(m, id)</span> </span>{
		<span class="hljs-keyword">var</span> query = sg.getMatch(model.label, <span class="hljs-string">'n'</span>) + sg.getWhereId(<span class="hljs-string">'n'</span>, model.id) + <span class="hljs-string">' WITH n '</span>
			      + sg.getMatch(m.label, <span class="hljs-string">'m'</span>) + sg.getWhereId(<span class="hljs-string">'m'</span>, id) + <span class="hljs-string">' WITH n,m '</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <ul>
<li>‘OPTIONAL MATCH (n)’ + sg.getDirection(model.definition[field].type.direction, model.definition[field].type.relationType, ‘r’) + ‘(m) DELETE r WITH n,m ‘</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  + <span class="hljs-string">'CREATE UNIQUE n'</span>+ sg.getDirection(model.definition[field].type.direction, model.definition[field].type.relationType) +<span class="hljs-string">'m RETURN n'</span>
		model.db().queryOneNodeAsync(query, {})
			.then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(n)</span></span>{
				<span class="hljs-keyword">return</span> deferred.resolve()
			})
			.catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span></span>{
				<span class="hljs-keyword">return</span> deferred.reject(err)
			})
	}

	<span class="hljs-keyword">if</span>(_.isNumber(model[field])) {
		createRelation(model.definition[field].type.to, model[field])
	} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(model[field] <span class="hljs-keyword">instanceof</span> Model) {
		model[field].persistSelf()
			.then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(m)</span></span>{
				createRelation(m, m.id)
			})
			.catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span></span>{
				<span class="hljs-keyword">return</span> deferred.reject(err)
			})
	}

	<span class="hljs-keyword">return</span> deferred.promise
}

<span class="hljs-keyword">var</span> persistManyRelation = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model, field)</span> </span>{
	<span class="hljs-keyword">var</span> deferred = Promise.defer()

	<span class="hljs-keyword">var</span> relationed = model.definition[field].type.to
	<span class="hljs-keyword">var</span> createRelation = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
		<span class="hljs-keyword">var</span> query = sg.getMatch(model.label, <span class="hljs-string">'n'</span>) + sg.getWhereId(<span class="hljs-string">'n'</span>, model.id) + <span class="hljs-string">' WITH n '</span>
			      + <span class="hljs-string">'OPTIONAL MATCH (n)'</span> + sg.getDirection(model.definition[field].type.direction, model.definition[field].type.relationType, <span class="hljs-string">'r'</span>)+<span class="hljs-string">'(:'</span> + relationed.label + <span class="hljs-string">') WITH n,r DELETE r WITH DISTINCT n '</span>
			      + sg.getMatch(relationed.label, <span class="hljs-string">'m'</span>) + <span class="hljs-string">'WHERE id(m) IN ['</span> + modelIds + <span class="hljs-string">'] WITH n,m '</span>
			      + <span class="hljs-string">'CREATE n'</span>+ sg.getDirection(model.definition[field].type.direction, model.definition[field].type.relationType) +<span class="hljs-string">'m RETURN n'</span>
		model.db().queryOneNodeAsync(query, {})
			.then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
				<span class="hljs-keyword">return</span> deferred.resolve()
			})
			.catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span></span>{
				<span class="hljs-keyword">return</span> deferred.reject(err)
			})
	}

	<span class="hljs-keyword">var</span> promises = []
	<span class="hljs-keyword">var</span> modelIds = []
	_.each(model[field], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(m)</span></span>{
		<span class="hljs-keyword">if</span>(_.isNumber(m)) {
			modelIds.push(m)
		} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(m <span class="hljs-keyword">instanceof</span> Model) {
			<span class="hljs-keyword">if</span>(m.isSyncronised) {
				modelIds.push(m.id)
			} <span class="hljs-keyword">else</span> {
				promises.push(m.persistSelf())
			}
		}
	})

	Promise.all(promises)
		.then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(models)</span></span>{
			<span class="hljs-keyword">var</span> ids = _.map(models, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(m)</span></span>{
				<span class="hljs-keyword">return</span> m.id
			})
			modelIds = _.union(modelIds,ids)
			createRelation()
		})
		.catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span></span>{
			<span class="hljs-keyword">return</span> deferred.reject(err)
		})

	<span class="hljs-keyword">return</span> deferred.promise
}

<span class="hljs-keyword">var</span> save = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model, relationed)</span> </span>{
	<span class="hljs-keyword">if</span>(relationed) relationed = _.intersection(relationed, model.getRelationFields())
	<span class="hljs-keyword">else</span> relationed = model.getRelationFields()
	<span class="hljs-keyword">var</span> deferred = Promise.defer()
	<span class="hljs-keyword">if</span>(!model.data) {
		<span class="hljs-keyword">return</span> deferred.reject(model.getNotInstantiatedError())
	}

	model.persistSelf()
		.then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(savedModel)</span></span>{
			<span class="hljs-keyword">var</span> relationPersistPromises = []
			_.each(relationed, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(field)</span></span>{
				<span class="hljs-keyword">if</span>(model[field]) {
					<span class="hljs-keyword">if</span>(model.definition[field].type <span class="hljs-keyword">instanceof</span> FieldTypes.OneRelation) {
						relationPersistPromises.push(model.persistOneRelation(field))
					} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (model.definition[field].type <span class="hljs-keyword">instanceof</span> FieldTypes.ManyRelation) {
						relationPersistPromises.push(model.persistManyRelation(field))
					}
				}
			}, savedModel)
			Promise.all(relationPersistPromises)
				.then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
					<span class="hljs-keyword">return</span> deferred.resolve(model)
				})
				.catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span></span>{
					<span class="hljs-keyword">return</span> deferred.reject(err)
				})
		})
		.catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span></span>{
			<span class="hljs-keyword">return</span> deferred.reject(err)
		})

	<span class="hljs-keyword">return</span> deferred.promise
}

<span class="hljs-keyword">var</span> remove = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model, id, hard)</span> </span>{
	<span class="hljs-keyword">if</span>(!id) {
		<span class="hljs-keyword">if</span>(model.id) {
			id = model.id
		}
	}

	<span class="hljs-keyword">var</span> query
	<span class="hljs-keyword">if</span>(hard) {
		query = sg.getMatch(model.label, <span class="hljs-string">'n'</span>) + sg.getWhereId(<span class="hljs-string">'n'</span>, id) + <span class="hljs-string">' OPTIONAL MATCH (n)-[r]-() DELETE n,r'</span>
	} <span class="hljs-keyword">else</span> {
		query = sg.getMatch(model.label, <span class="hljs-string">'n'</span>) + sg.getWhereId(<span class="hljs-string">'n'</span>, id) + <span class="hljs-string">' REMOVE n:'</span>+ model.label +<span class="hljs-string">' SET n:_'</span>+model.label
	}
	<span class="hljs-keyword">var</span> deferred = Promise.defer()
	<span class="hljs-keyword">if</span>(model.getEvents()[Constants.Events.preDelete])
		model.getEvents()[Constants.Events.preDelete].run(model)
	model.db().queryOneNodeAsync(query, <span class="hljs-literal">null</span>)
		.then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
			<span class="hljs-keyword">if</span>(model.getEvents()[Constants.Events.postDelete])
				model.getEvents()[Constants.Events.postDelete].run(model)
			model.isSyncronised = <span class="hljs-literal">true</span>
			<span class="hljs-keyword">return</span> deferred.resolve(model)
		})
		.catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span></span>{
			<span class="hljs-keyword">return</span> deferred.reject(err)
		})
	<span class="hljs-keyword">return</span> deferred.promise
}

<span class="hljs-built_in">module</span>.exports = {
	persistModel: persistModel,
	persistOneRelation: persistOneRelation,
	persistManyRelation: persistManyRelation,
	save: save,
	remove: remove
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
