<!DOCTYPE html>

<html>
<head>
  <title>Utils.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>Utils.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/**
 * Created by Dragos on 7/8/14.
 */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Get &amp; Set wrappers to fix scoping issues caused by defining properties</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> wrapSet = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(instance, definition)</span> </span>{
	<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(newValue)</span></span>{
		instance.set(definition, newValue)
	}
}

<span class="hljs-keyword">var</span> wrapGet = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(instance, definition)</span> </span>{
	<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span></span>{
		<span class="hljs-keyword">return</span> instance.get(definition)
	}
}</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Helper function to call when ending one queries.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> executeSingle = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model, query)</span> </span>{
	<span class="hljs-keyword">var</span> deferred = Promise.defer()
	model.db().queryOneScalarAsync(query, {})
		.then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(result)</span></span>{
			<span class="hljs-keyword">if</span>(!result) {
				deferred.reject(<span class="hljs-keyword">new</span> Errors.NodeNotFoundError(<span class="hljs-string">'Node not found!'</span>))
				<span class="hljs-keyword">return</span>
			}
			<span class="hljs-keyword">if</span>(result.data) result = result.data
			<span class="hljs-keyword">var</span> modelInstance = model.instantiate(result)
			modelInstance.isSyncronised = <span class="hljs-literal">true</span>
			deferred.resolve(modelInstance)
		})
		.catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span></span>{
			deferred.reject(<span class="hljs-string">'Query: '</span> + query + <span class="hljs-string">' '</span> + err)
		})
	<span class="hljs-keyword">return</span> deferred.promise
}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Helper function to call when ending many queries.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> executeMany = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model, query)</span> </span>{
	<span class="hljs-keyword">var</span> deferred = Promise.defer()
	model.db().queryManyScalarsAsync(query, {})
		.then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(result)</span></span>{
			<span class="hljs-keyword">var</span> models = []
			result.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span></span>{
				<span class="hljs-keyword">var</span> modelInstance = model.instantiate(data)
				modelInstance.isSyncronised = <span class="hljs-literal">true</span>
				models.push(modelInstance)
			})
			deferred.resolve(models)
		})
		.catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span></span>{
			deferred.reject(<span class="hljs-string">'Query: '</span> + query + <span class="hljs-string">' '</span> + err)
		})
	<span class="hljs-keyword">return</span> deferred.promise
}</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Verify if clause has correct fields</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> checkClause = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(clause)</span> </span>{
	<span class="hljs-keyword">if</span>(_.isUndefined(clause.operator))
		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'You must supply a clause to the addWhere method.'</span>)
	<span class="hljs-keyword">var</span> isOperatorSupported = <span class="hljs-literal">false</span>
	_.each(Constants.Operators, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v,k)</span></span>{
		<span class="hljs-keyword">if</span>(k === clause.operator) isOperatorSupported = <span class="hljs-literal">true</span>
	})
	<span class="hljs-keyword">if</span>(!isOperatorSupported)
		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(clause.operator + <span class="hljs-string">' is not a supported operator on the clause. Operators: '</span> + Constants.Operators)
	<span class="hljs-keyword">if</span>(_.isUndefined(clause.field))
		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'You must supply a field on the clause.'</span>)
	<span class="hljs-keyword">if</span>(_.isUndefined(clause.value))
		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'You must supply a value on the clause.'</span>)
}</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Make clauses work with RQL style syntax</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> transformClauseFromOldSyntax = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(clause)</span> </span>{
	<span class="hljs-keyword">return</span> {
		operator: clause.op,
		field: clause.args[<span class="hljs-number">0</span>],
		value: clause.args[<span class="hljs-number">1</span>]
	}
}

<span class="hljs-keyword">var</span> checkModels = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(models)</span> </span>{
	<span class="hljs-keyword">if</span>(_.isArray(models)) {
		_.each(models, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model)</span></span>{
			<span class="hljs-keyword">if</span>(!(model <span class="hljs-keyword">instanceof</span> Model)) {
				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'The array you supplied should only contain Model instances.'</span>)
			}
		})
	} <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Please supply an array of models to this method.'</span>)
}

<span class="hljs-built_in">module</span>.exports = {
	wrapSet: wrapSet,
	wrapGet: wrapGet,
	executeSingle: executeSingle,
	executeMany: executeMany,
	checkClause: checkClause,
	transformClauseFromOldSyntax: transformClauseFromOldSyntax,
	checkModels: checkModels
}

<span class="hljs-keyword">var</span> Promise = <span class="hljs-built_in">require</span>(<span class="hljs-string">'bluebird'</span>)
<span class="hljs-keyword">var</span> Errors = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Errors'</span>)
<span class="hljs-keyword">var</span> Constants = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Constants'</span>)
<span class="hljs-keyword">var</span> Model = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Model'</span>)
<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>)</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
