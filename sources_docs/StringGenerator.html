<!DOCTYPE html>

<html>
<head>
  <title>StringGenerator.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>StringGenerator.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/**
 * Created by Dragos on 6/5/14.
 */</span>


<span class="hljs-keyword">var</span> StringGenerator = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
	<span class="hljs-keyword">this</span>.names = <span class="hljs-keyword">new</span> MapNameUtility()
	<span class="hljs-keyword">this</span>.relationMap = {}
}

StringGenerator.prototype.getDirection = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(direction, relationType, variable, inverse)</span> </span>{
	<span class="hljs-keyword">if</span>(!direction || !relationType)
		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Please supply direction and relationType to the function.'</span>)
	<span class="hljs-keyword">if</span>(!variable) variable = <span class="hljs-string">''</span>
	<span class="hljs-keyword">var</span> inDirection = <span class="hljs-literal">false</span>
	<span class="hljs-keyword">var</span> outDirection = <span class="hljs-literal">false</span>
	<span class="hljs-keyword">if</span>(direction.indexOf(Constants.Directions.In) &gt; -<span class="hljs-number">1</span>)
		inDirection = <span class="hljs-literal">true</span>
	<span class="hljs-keyword">if</span>(direction.indexOf(Constants.Directions.Out) &gt; -<span class="hljs-number">1</span>)
		outDirection = <span class="hljs-literal">true</span>
	<span class="hljs-keyword">var</span> str = (inDirection==<span class="hljs-literal">true</span>?Constants.Directions.In:<span class="hljs-string">''</span>) +
		         <span class="hljs-string">'-['</span>+variable+<span class="hljs-string">':'</span> + relationType + <span class="hljs-string">']-'</span> +
	          (outDirection==<span class="hljs-literal">true</span>?Constants.Directions.Out:<span class="hljs-string">''</span>)
	<span class="hljs-keyword">return</span> str
}

StringGenerator.prototype.getMap = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(mapName, propertiesList, selectList, isIdSupplied)</span> </span>{
	<span class="hljs-keyword">var</span> query = []
	propertiesList.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v,k)</span></span>{
		<span class="hljs-keyword">if</span>(v===<span class="hljs-string">'id'</span>) {
			<span class="hljs-keyword">if</span>(isIdSupplied) {
				query.push(<span class="hljs-string">'id:'</span> + mapName + <span class="hljs-string">'.`id`'</span>)
				<span class="hljs-keyword">return</span>
			}
			query.push(<span class="hljs-string">'id:id('</span> + mapName + <span class="hljs-string">')'</span>)
			<span class="hljs-keyword">return</span>
		}
		<span class="hljs-keyword">if</span>(selectList &amp;&amp; selectList.length !== <span class="hljs-number">0</span>) {
			<span class="hljs-keyword">if</span>(selectList.indexOf(v) !== -<span class="hljs-number">1</span>){
				query.push(v + <span class="hljs-string">':'</span> + mapName + <span class="hljs-string">'.`'</span> + v + <span class="hljs-string">'`'</span>)
			}
		} <span class="hljs-keyword">else</span> {
			query.push(v + <span class="hljs-string">':'</span> + mapName + <span class="hljs-string">'.`'</span> + v + <span class="hljs-string">'`'</span>)
		}
	}, <span class="hljs-keyword">this</span>)
	<span class="hljs-keyword">return</span> query.join(<span class="hljs-string">', '</span>)
}

StringGenerator.prototype.getWith = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(usedMapNames, mapName, nextMapName, propertiesList, selectList)</span> </span>{
	<span class="hljs-keyword">var</span> query = <span class="hljs-string">'WITH '</span> + usedMapNames + <span class="hljs-string">'{'</span> + <span class="hljs-keyword">this</span>.getMap(mapName, propertiesList, selectList, <span class="hljs-literal">false</span>) + <span class="hljs-string">'} '</span> +
				<span class="hljs-string">'AS '</span> + nextMapName + <span class="hljs-string">' '</span>
	<span class="hljs-keyword">return</span> query
}

StringGenerator.prototype.getWithFromRelation = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(usedMapNames, relationMapName, nextRelationMapName,
														 propertiesList, selectList)</span> </span>{
	<span class="hljs-keyword">var</span> query = <span class="hljs-string">'WITH '</span> + usedMapNames + <span class="hljs-string">'{'</span> +
				<span class="hljs-keyword">this</span>.getMap(relationMapName, propertiesList, selectList, <span class="hljs-literal">false</span>) + <span class="hljs-string">'} '</span> +
				<span class="hljs-string">'AS '</span> + nextRelationMapName + <span class="hljs-string">' '</span>
	<span class="hljs-keyword">return</span> query
}

StringGenerator.prototype.getEmbeddedWith = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(usedMapNames, lastMapName, primitivePropertiesList,
													 relationPropertiesList, selectList, relationMap)</span> </span>{
	<span class="hljs-keyword">var</span> query = <span class="hljs-string">'WITH '</span> + usedMapNames + <span class="hljs-string">'{'</span> + <span class="hljs-keyword">this</span>.getMap(lastMapName, primitivePropertiesList, selectList, <span class="hljs-literal">true</span>) + <span class="hljs-string">' '</span>
	<span class="hljs-keyword">var</span> partialQuery = []
	<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> relation <span class="hljs-keyword">in</span> relationMap) {
		partialQuery.push(relation + <span class="hljs-string">':'</span> + relationMap[relation])
	}
	<span class="hljs-keyword">return</span> query + partialQuery.join(<span class="hljs-string">', '</span>)
}

StringGenerator.prototype.getMatch = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(modelName, mapName)</span> </span>{
	<span class="hljs-keyword">if</span>(modelName) <span class="hljs-keyword">return</span> <span class="hljs-string">'MATCH ('</span> + mapName + <span class="hljs-string">':'</span> + modelName + <span class="hljs-string">') '</span>
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-string">'MATCH ('</span> + modelName + <span class="hljs-string">') '</span>
}

StringGenerator.prototype.getWhereId = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(mapName, id)</span> </span>{
	<span class="hljs-keyword">return</span> <span class="hljs-string">'WHERE id('</span> + mapName + <span class="hljs-string">')='</span> + id + <span class="hljs-string">' '</span>
}

StringGenerator.prototype.getReturn = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(mapName, propertiesList, selectList, isIdSupplied)</span> </span>{
	<span class="hljs-keyword">var</span> returnQuery = <span class="hljs-string">'RETURN DISTINCT {'</span> + <span class="hljs-keyword">this</span>.getMap(mapName, propertiesList, selectList, isIdSupplied)
	<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> relation <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.relationMap) {
		returnQuery += <span class="hljs-string">', '</span> + relation + <span class="hljs-string">':'</span> + <span class="hljs-keyword">this</span>.relationMap[relation]
	}
	returnQuery += <span class="hljs-string">'}'</span>
	<span class="hljs-keyword">return</span> returnQuery
}

StringGenerator.prototype.getCount = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(mapName)</span> </span>{
	<span class="hljs-keyword">if</span>(!mapName) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Please supply mapName to function.'</span>)
	<span class="hljs-keyword">return</span> <span class="hljs-string">'RETURN count('</span> + mapName + <span class="hljs-string">')'</span>
}

StringGenerator.prototype.getRange = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(skip, limit)</span> </span>{
    <span class="hljs-keyword">var</span> query = []
    <span class="hljs-keyword">if</span> (skip)
        query.push(<span class="hljs-string">'SKIP '</span> + skip)
    <span class="hljs-keyword">if</span> (limit)
        query.push(<span class="hljs-string">'LIMIT '</span> + limit)
    <span class="hljs-keyword">return</span> query.join(<span class="hljs-string">' '</span>)
}

StringGenerator.prototype.getRevertedNodesFromMap = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(currentMapName, lastMapName, label)</span> </span>{
	<span class="hljs-keyword">var</span> query = <span class="hljs-keyword">this</span>.getMatch(label, currentMapName) + <span class="hljs-keyword">this</span>.getWhereId(currentMapName, lastMapName) + <span class="hljs-string">'.id'</span>
	<span class="hljs-keyword">return</span> query
}

StringGenerator.prototype.getRelationMatch = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(currentMapName, currentRelationMapName,
													  label, definition)</span> </span>{
	<span class="hljs-keyword">var</span> query = <span class="hljs-keyword">this</span>.getMatch(label, currentMapName) +
				<span class="hljs-keyword">this</span>.getDirection(definition.type.direction, definition.type.relationType) + <span class="hljs-string">'('</span> + currentRelationMapName + <span class="hljs-string">':'</span> +
				definition.type.to.label + <span class="hljs-string">') '</span>
	<span class="hljs-keyword">return</span> query
}

StringGenerator.prototype.getOptionalRelationMatch = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(currentMapName, currentRelationMapName,
															  label, definition)</span> </span>{
	<span class="hljs-keyword">var</span> query = <span class="hljs-string">'OPTIONAL '</span>+ <span class="hljs-keyword">this</span>.getRelationMatch(currentMapName, currentRelationMapName, label, definition)
	<span class="hljs-keyword">return</span> query
}

StringGenerator.prototype.getCreate = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(modelLabel, modelVar, modelDataVar)</span> </span>{
	<span class="hljs-keyword">var</span> query = <span class="hljs-string">'CREATE ('</span> + modelVar +<span class="hljs-string">':'</span> + modelLabel + <span class="hljs-string">' {'</span> + modelDataVar + <span class="hljs-string">'}) '</span>
	<span class="hljs-keyword">return</span> query
}

StringGenerator.prototype.getWhere = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(mapName, operator, field, value, continuation)</span> </span>{
	<span class="hljs-keyword">var</span> initial
	<span class="hljs-keyword">if</span>(!continuation)
		initial = <span class="hljs-string">'WHERE '</span>
	<span class="hljs-keyword">else</span>
		initial = continuation.trim() + <span class="hljs-string">' '</span>

	<span class="hljs-keyword">if</span>(field==<span class="hljs-string">"id"</span>)
		<span class="hljs-keyword">return</span> initial + <span class="hljs-string">'id('</span> + mapName + <span class="hljs-string">') '</span> + operator + <span class="hljs-string">' '</span> + value
	<span class="hljs-keyword">if</span>(!_.isNumber(value) &amp;&amp; !_.isBoolean(value))
		value = <span class="hljs-string">'"'</span> + value + <span class="hljs-string">'"'</span>
	<span class="hljs-keyword">if</span>(operator==Constants.Operators.in)
		value = <span class="hljs-string">'['</span> + value.toString() + <span class="hljs-string">']'</span>
	<span class="hljs-keyword">return</span> initial + mapName + <span class="hljs-string">'.'</span> + field + <span class="hljs-string">' '</span> + operator + <span class="hljs-string">' '</span> + value
}

<span class="hljs-keyword">var</span> Model = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Model'</span>)
<span class="hljs-keyword">var</span> Constants = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Constants'</span>)
<span class="hljs-keyword">var</span> MapNameUtility = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./MapNameUtility'</span>)
<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>)

<span class="hljs-built_in">module</span>.exports = StringGenerator</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
